@*
 * Copyright 2021 HM Revenue & Customs
 *
 *@

@import uk.gov.hmrc.customs.financials.views.html.components._
@import uk.gov.hmrc.customs.financials.domain.PostponedVatCertificateFile
@import uk.gov.hmrc.customs.financials.domain.FileFormat._
@import uk.gov.hmrc.customs.financials.views.helpers.Formatters

@this(
    mainTemplate: uk.gov.hmrc.customs.financials.views.html.alphagov_main_template
)

@(eori: String, statementGroups: Seq[PostponedVatStatementGroup], cdsOnly: Boolean)(implicit request: Request[_], messages: Messages, appConfig: uk.gov.hmrc.customs.financials.config.AppConfig)

@mainTemplate(title = Some(messages("cf.account.pvat.title")), beforeContentBlock = None, helpAndSupport = true) {

    @recruitment_banner()

    <span class="govuk-caption-xl" id="eori-heading">
        @messages("cf.eori")
        <span id="eori">@{
            eori
        }</span>
    </span>
    <h1 class="govuk-heading-xl  govuk-!-margin-bottom-6">
    @messages("cf.account.pvat.title")
    </h1>

    @if(messages.isDefinedAt("cf.account.pvat.holding-message.1")) {
        <p class="govuk-body govuk-!-margin-bottom-6" id="postponed-vat-holding-message">
            @messages("cf.account.pvat.holding-message.1")
            <a class="govuk-link" href="https://www.gov.uk/guidance/check-when-you-can-account-for-import-vat-on-your-vat-return">@messages("cf.account.pvat.link-message")</a>
            @messages("cf.account.pvat.holding-message.2")
        </p>
    }

    <p class="govuk-body govuk-!-margin-bottom-6" id="postponed-vat-content">
    @messages("cf.account.pvat.content")
    </p>

    @for(statementGroup <- statementGroups) {
        <div id=@{
            statementGroup.periodId
        }>
            <h2 class="govuk-heading-m">@{
                Formatters.dateAsMonthAndYear(statementGroup.startDate)
            }</h2>
            @if(statementGroup.noStatements) {
                <ul class="govuk-list">
                    <li>@messages("cf.account.pvat.statements.unavailable",Formatters.dateAsMonth(statementGroup.startDate))</li>
                </ul>

            } else {
                <ul class="govuk-list">
                @for(source <- PostponedVat.sources) {
                    @collapsibleStatementGroup(
                        statementGroup.collectFiles(amended = true, source),
                        "cf.account.pvat.amended-download-link",
                        "cf.account.pvat.aria.amended-download-link",
                        None,
                        source,
                        Formatters.dateAsMonthAndYear(statementGroup.startDate)
                    )
                    @defining(if(statementGroup.collectFiles(amended = true, source).isEmpty) "" else "original.") { original =>
                        @collapsibleStatementGroup(
                            statementGroup.collectFiles(amended = false, source),
                            s"cf.account.pvat.${original}download-link",
                            s"cf.account.pvat.aria.${original}download-link",
                            Some(s"cf.account.pvat.${original}missing-file-type"),
                            source,
                            Formatters.dateAsMonthAndYear(statementGroup.startDate)
                        )
                    }
                }
                </ul>
            }
        </div>
    }

    @if(statementGroups.isEmpty) {
        <div class="govuk-inset-text govuk-!-margin-bottom-9 govuk-!-margin-top-8">
        @messages("cf.account.pvat.no-statements-yet")
        </div>
    } else {
        <div class="govuk-inset-text govuk-!-margin-bottom-9 govuk-!-margin-top-8">
        @messages("cf.legal-notice.import-vat.parttwo")
        </div>
    }
}

@collapsibleStatementGroup(certificateFiles: Seq[PostponedVatCertificateFile], downloadLinkMessage: String, downloadAriaLabel: String, missingFileMessage: Option[String], source: String, period: String) = {
@if(certificateFiles.nonEmpty) {
    @for(certificates <- certificateFiles.groupBy(_.eori).values) {
        @for(fileFormat <- PvatFileFormats) {
            @downloadLink(fileFormat, certificates.filter(_.fileFormat == fileFormat), downloadLinkMessage, downloadAriaLabel, period)
        }
    }
} else {
    @missingFileMessage.map{v => <li>@messages(v, source)</li>}
}
}

@downloadLink(fileFormat: FileFormat, certificateFiles: Seq[PostponedVatCertificateFile], downloadLinkMessage: String, downloadAriaLabel: String, period: String) = {
@for(certificateFile <- certificateFiles) {
    <li>
        <a
        class="govuk-link"
        href="@{certificateFile.downloadURL}"
        aria-label="@{messages(
            downloadAriaLabel,
            certificateFile.metadata.source,
            period,
            fileFormat.name,
            Formatters.fileSize(certificateFile.size)
        )}"
        >
        @messages(
            downloadLinkMessage,
            certificateFile.metadata.source,
            fileFormat.name,
            Formatters.fileSize(certificateFile.size),
            period
        )
        </a>
    </li>
}
}
